<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #0ea5e9;
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #10b981;
      --dark: #0f172a;
      --text: #e5e7eb;
      --muted: #94a3b8;
    }

    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(135deg, #020617 0%, #0f172a 100%);
      color: var(--text);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #1e293b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
    }

    .btn {
      padding: 10px 16px;
      border: 1px solid #1e293b;
      border-radius: 8px;
      background: rgba(30, 41, 59, 0.5);
      color: var(--text);
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .btn:hover {
      border-color: var(--primary);
      background: rgba(14, 165, 233, 0.1);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #1e293b;
      border-radius: 12px;
      padding: 20px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-card.primary .stat-value { color: var(--primary); }
    .stat-card.success .stat-value { color: var(--success); }
    .stat-card.warning .stat-value { color: var(--warning); }
    .stat-card.danger .stat-value { color: var(--danger); }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart-card {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #1e293b;
      border-radius: 12px;
      padding: 20px;
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
    }

    canvas {
      max-height: 300px;
    }

    .table-card {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #1e293b;
      border-radius: 12px;
      padding: 20px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th {
      background: rgba(14, 165, 233, 0.1);
      padding: 12px;
      text-align: right;
      font-weight: 600;
      border-bottom: 1px solid #1e293b;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid rgba(30, 41, 59, 0.5);
    }

    tr:hover {
      background: rgba(14, 165, 233, 0.05);
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge.success {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .badge.warning {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .badge.danger {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h1>
      <div>
        <button class="btn" onclick="window.location.href='/static/operations-dashboard.html'">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
        <button class="btn" onclick="exportReport()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card primary">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</div>
        <div class="stat-value" id="total-events">0</div>
        <div class="stat-label">Ù…Ù†Ø° Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</div>
      </div>

      <div class="stat-card success">
        <div class="stat-label">Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†</div>
        <div class="stat-value" id="safe-events">0</div>
        <div class="stat-label">âœ… Ø¢Ù…Ù†</div>
      </div>

      <div class="stat-card warning">
        <div class="stat-label">Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ­Ø°ÙŠØ±</div>
        <div class="stat-value" id="warning-events">0</div>
        <div class="stat-label">âš ï¸ ØºÙŠØ± Ù…Ø³ØªÙ‚Ø±</div>
      </div>

      <div class="stat-card danger">
        <div class="stat-label">Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</div>
        <div class="stat-value" id="danger-events">0</div>
        <div class="stat-label">ğŸš¨ Ø®Ø·Ø±</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title">ğŸ“ˆ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</div>
        <canvas id="typeChart"></canvas>
      </div>

      <div class="chart-card">
        <div class="chart-title">ğŸ“Š Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø­Ø³Ø¨ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©</div>
        <canvas id="levelChart"></canvas>
      </div>

      <div class="chart-card">
        <div class="chart-title">â° Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©</div>
        <canvas id="timeChart"></canvas>
      </div>

      <div class="chart-card">
        <div class="chart-title">ğŸ‘® Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª</div>
        <canvas id="officerChart"></canvas>
      </div>
    </div>

    <div class="table-card">
      <div class="chart-title">ğŸ“‹ Ø£ÙƒØ«Ø± Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ù†Ø´Ø§Ø·Ø§Ù‹</div>
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ø¯ÙˆØ±ÙŠØ©</th>
            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</th>
            <th>Ø¢Ù…Ù†</th>
            <th>ØºÙŠØ± Ù…Ø³ØªÙ‚Ø±</th>
            <th>Ø®Ø·Ø±</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
          </tr>
        </thead>
        <tbody id="officer-stats"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = "https://syntrue-absher.onrender.com/api/events";
    let allEvents = [];

    async function fetchData() {
      try {
        const response = await fetch(API_URL);
        allEvents = await response.json();
        updateStats();
        updateCharts();
        updateOfficerTable();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function updateStats() {
      const total = allEvents.length;
      const safe = allEvents.filter(e => e.level === 'info').length;
      const warning = allEvents.filter(e => e.level === 'warning').length;
      const danger = allEvents.filter(e => e.level === 'danger').length;

      document.getElementById('total-events').textContent = total;
      document.getElementById('safe-events').textContent = safe;
      document.getElementById('warning-events').textContent = warning;
      document.getElementById('danger-events').textContent = danger;
    }

    function updateCharts() {
      // Type distribution
      const types = {};
      allEvents.forEach(e => {
        types[e.type] = (types[e.type] || 0) + 1;
      });

      new Chart(document.getElementById('typeChart'), {
        type: 'doughnut',
        data: {
          labels: Object.keys(types),
          datasets: [{
            data: Object.values(types),
            backgroundColor: ['#0ea5e9', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: '#e5e7eb' } }
          }
        }
      });

      // Level distribution
      const levels = {
        'info': allEvents.filter(e => e.level === 'info').length,
        'warning': allEvents.filter(e => e.level === 'warning').length,
        'danger': allEvents.filter(e => e.level === 'danger').length
      };

      new Chart(document.getElementById('levelChart'), {
        type: 'bar',
        data: {
          labels: ['Ø¢Ù…Ù†', 'ØºÙŠØ± Ù…Ø³ØªÙ‚Ø±', 'Ø®Ø·Ø±'],
          datasets: [{
            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«',
            data: [levels.info, levels.warning, levels.danger],
            backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: '#e5e7eb' } }
          },
          scales: {
            y: { ticks: { color: '#94a3b8' } },
            x: { ticks: { color: '#94a3b8' } }
          }
        }
      });

      // Time distribution (last 24 hours)
      const hourCounts = Array(24).fill(0);
      allEvents.forEach(e => {
        const hour = new Date(e.timestamp).getHours();
        hourCounts[hour]++;
      });

      new Chart(document.getElementById('timeChart'), {
        type: 'line',
        data: {
          labels: Array.from({length: 24}, (_, i) => `${i}:00`),
          datasets: [{
            label: 'Ø§Ù„Ø£Ø­Ø¯Ø§Ø«',
            data: hourCounts,
            borderColor: '#0ea5e9',
            backgroundColor: 'rgba(14, 165, 233, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: '#e5e7eb' } }
          },
          scales: {
            y: { ticks: { color: '#94a3b8' } },
            x: { ticks: { color: '#94a3b8' } }
          }
        }
      });

      // Officer performance
      const officers = {};
      allEvents.forEach(e => {
        if (e.device_id && e.device_id.startsWith('officer_')) {
          officers[e.device_id] = (officers[e.device_id] || 0) + 1;
        }
      });

      new Chart(document.getElementById('officerChart'), {
        type: 'bar',
        data: {
          labels: Object.keys(officers).map(o => o.replace('officer_', 'Ø¯ÙˆØ±ÙŠØ© ')),
          datasets: [{
            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«',
            data: Object.values(officers),
            backgroundColor: '#0ea5e9'
          }]
        },
        options: {
          responsive: true,
          indexAxis: 'y',
          plugins: {
            legend: { labels: { color: '#e5e7eb' } }
          },
          scales: {
            y: { ticks: { color: '#94a3b8' } },
            x: { ticks: { color: '#94a3b8' } }
          }
        }
      });
    }

    function updateOfficerTable() {
      const officers = {};
      allEvents.forEach(e => {
        if (e.device_id && e.device_id.startsWith('officer_')) {
          if (!officers[e.device_id]) {
            officers[e.device_id] = { total: 0, safe: 0, warning: 0, danger: 0, latest: e };
          }
          officers[e.device_id].total++;
          if (e.level === 'info') officers[e.device_id].safe++;
          if (e.level === 'warning') officers[e.device_id].warning++;
          if (e.level === 'danger') officers[e.device_id].danger++;
          if (new Date(e.timestamp) > new Date(officers[e.device_id].latest.timestamp)) {
            officers[e.device_id].latest = e;
          }
        }
      });

      const tbody = document.getElementById('officer-stats');
      tbody.innerHTML = Object.entries(officers)
        .sort((a, b) => b[1].total - a[1].total)
        .map(([id, data]) => {
          const status = data.latest.level === 'info' ? 'success' : 
                        data.latest.level === 'warning' ? 'warning' : 'danger';
          const statusText = data.latest.level === 'info' ? 'Ø¢Ù…Ù†' : 
                            data.latest.level === 'warning' ? 'ØºÙŠØ± Ù…Ø³ØªÙ‚Ø±' : 'Ø®Ø·Ø±';
          return `
            <tr>
              <td>${id.replace('officer_', 'Ø§Ù„Ø¯ÙˆØ±ÙŠØ© Ø±Ù‚Ù… ')}</td>
              <td><strong>${data.total}</strong></td>
              <td>${data.safe}</td>
              <td>${data.warning}</td>
              <td>${data.danger}</td>
              <td><span class="badge ${status}">${statusText}</span></td>
            </tr>
          `;
        }).join('');
    }

    function exportReport() {
      const report = {
        timestamp: new Date().toISOString(),
        total: allEvents.length,
        summary: {
          safe: allEvents.filter(e => e.level === 'info').length,
          warning: allEvents.filter(e => e.level === 'warning').length,
          danger: allEvents.filter(e => e.level === 'danger').length
        },
        events: allEvents
      };

      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `security-report-${new Date().toISOString().slice(0, 10)}.json`;
      a.click();
    }

    window.addEventListener('load', () => {
      fetchData();
      setInterval(fetchData, 5000);
    });
  </script>
</body>
</html>
