<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ</title>

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Heatmap -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      padding: 20px;
      background: #0f172a;
      color: #e5e7eb;
      font-family: system-ui, sans-serif;
      direction: rtl;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #1e293b;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      margin: 0;
      font-size: 1.5rem;
      color: #38bdf8;
    }

    .status {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .conn-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ef4444;
      animation: blink 1s infinite;
    }

    .conn-dot.online {
      background: #22c55e;
      animation: none;
    }

    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    button {
      background: #0ea5e9;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }

    button:hover {
      background: #38bdf8;
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(14, 165, 233, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    button.danger {
      background: #ef4444;
    }

    button.danger:hover {
      background: #f87171;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .card {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #1e293b;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .card h3 {
      margin: 0 0 10px;
      font-size: 0.9rem;
      color: #9ca3af;
      text-transform: uppercase;
    }

    .number {
      font-size: 2rem;
      font-weight: bold;
      color: #38bdf8;
    }

    .card.danger .number {
      color: #ef4444;
    }

    .map-container {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #1e293b;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .map-container h2 {
      margin: 0;
      padding: 15px;
      border-bottom: 1px solid #1e293b;
      font-size: 1.2rem;
    }

    #map {
      width: 100%;
      height: 400px;
    }

    .table-container {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #1e293b;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .table-container h2 {
      margin: 0;
      padding: 15px;
      border-bottom: 1px solid #1e293b;
      font-size: 1.2rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      padding: 15px;
    }

    th {
      background: #0f172a;
      padding: 10px;
      text-align: right;
      font-weight: 600;
      border-bottom: 2px solid #1e293b;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #1e293b;
      text-align: right;
    }

    tr:hover {
      background: rgba(56, 189, 248, 0.1);
    }

    .danger-row { background: rgba(239, 68, 68, 0.1); }
    .warning-row { background: rgba(234, 179, 8, 0.1); }
    .info-row { background: rgba(34, 197, 94, 0.1); }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    select {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #1e293b;
      border-radius: 6px;
      padding: 8px;
      cursor: pointer;
    }

    .chart-container {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #1e293b;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }

    #liveChart {
      max-height: 250px;
    }

    @media (max-width: 1024px) {
      .grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 640px) {
      .grid { grid-template-columns: 1fr; }
      header { flex-direction: column; gap: 10px; }
      #map { height: 300px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>ğŸ”’ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ</h1>
        <p style="margin: 5px 0 0; color: #9ca3af;">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ù†Ø²Ù„ Ø§Ù„Ø°ÙƒÙŠØ© ÙˆØ§Ù„Ø¯ÙˆØ±ÙŠØ§Øª ÙˆØ§Ù„Ø¯Ø±ÙˆÙ†</p>
      </div>
      <div class="status">
        <span id="status-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</span>
        <div id="conn-dot" class="conn-dot"></div>
      </div>
    </header>

    <div class="controls">
      <button onclick="toggleFetch()">â¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«</button>
      <button onclick="startSimulation()">â–¶ï¸ ØªØ´ØºÙŠÙ„ Ù…Ø­Ø§ÙƒØ§Ø©</button>
      <button onclick="getEvents()">ğŸ”„ ØªØ­Ø¯ÙŠØ« ÙŠØ¯ÙˆÙŠ</button>
      <button class="danger" onclick="resetEvents()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>

    <!-- Statistics -->
    <div class="grid">
      <div class="card">
        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h3>
        <div class="number" id="total-count">0</div>
      </div>
      <div class="card danger">
        <h3>Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø®Ø·ÙŠØ±Ø©</h3>
        <div class="number" id="danger-count">0</div>
      </div>
      <div class="card">
        <h3>Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª</h3>
        <div class="number" id="warning-count">0</div>
      </div>
      <div class="card">
        <h3>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</h3>
        <div style="font-size: 0.9rem; color: #9ca3af;" id="last-update">Ø§Ù„Ø¢Ù†</div>
      </div>
    </div>

    <!-- Map -->
    <div class="map-container">
      <h2>ğŸ—ºï¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ø£Ù…Ø§Ù†</h2>
      <div id="map"></div>
    </div>

    <!-- Chart -->
    <div class="chart-container">
      <h2>ğŸ“Š Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ</h2>
      <canvas id="liveChart"></canvas>
    </div>

    <!-- Events Table -->
    <div class="table-container">
      <h2>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h2>
      <div class="filters">
        <select id="level-filter" onchange="getEvents()">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          <option value="danger">ğŸ”´ Ø®Ø·Ø±</option>
          <option value="warning">ğŸŸ¡ ØªØ­Ø°ÙŠØ±</option>
          <option value="info">ğŸŸ¢ Ù…Ø¹Ù„ÙˆÙ…Ø©</option>
        </select>
        <select id="device-filter" onchange="getEvents()">
          <option value="">ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</option>
        </select>
      </div>
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
            <th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
            <th>Ø§Ù„Ù†ÙˆØ¹</th>
            <th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          </tr>
        </thead>
        <tbody id="events-table"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin + "/api/events";
    let allEvents = [];
    let fetchInterval = null;
    let chartInstance = null;
    let map = null;
    let heatPoints = [];
    let isFetching = true;

    // Initialize Map
    function initMap() {
      if (map) return;
      const center = [24.7136, 46.6753];
      map = L.map('map').setView(center, 14);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
    }

    // Initialize Chart
    function initChart() {
      const ctx = document.getElementById('liveChart').getContext('2d');
      chartInstance = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«', data: [], borderColor: '#0ea5e9', backgroundColor: 'rgba(14, 165, 233, 0.1)', tension: 0.3 }] },
        options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { labels: { color: '#e5e7eb' } } }, scales: { y: { ticks: { color: '#9ca3af' }, beginAtZero: true }, x: { ticks: { color: '#9ca3af' } } } }
      });
    }

    // Update Map
    function updateMap(events) {
      if (!map) return;
      heatPoints = events.filter(e => e.level === 'danger').map(e => {
        const coords = getDeviceCoords(e.device_id);
        return [coords[0], coords[1], 1];
      });
      L.heatLayer(heatPoints, { radius: 35, blur: 25, maxZoom: 18 }).addTo(map);
    }

    function getDeviceCoords(deviceId) {
      const coords = {
        'door_sensor_1': [24.7136, 46.6753],
        'motion_sensor_1': [24.7143, 46.6768],
        'camera_front': [24.7129, 46.6742],
        'gas_sensor_kitchen': [24.7130, 46.6760],
      };
      return coords[deviceId] || [24.7136, 46.6753];
    }

    // Update Chart
    function updateChart() {
      if (!chartInstance) return;
      const now = new Date();
      const label = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
      chartInstance.data.labels.push(label);
      chartInstance.data.datasets[0].data.push(allEvents.length);
      if (chartInstance.data.labels.length > 15) {
        chartInstance.data.labels.shift();
        chartInstance.data.datasets[0].data.shift();
      }
      chartInstance.update('none');
    }

    // Update Stats
    function updateStats() {
      const danger = allEvents.filter(e => e.level === 'danger').length;
      const warning = allEvents.filter(e => e.level === 'warning').length;
      document.getElementById('total-count').textContent = allEvents.length;
      document.getElementById('danger-count').textContent = danger;
      document.getElementById('warning-count').textContent = warning;
      document.getElementById('last-update').textContent = new Date().toLocaleTimeString('ar-SA');

      const connDot = document.getElementById('conn-dot');
      const statusText = document.getElementById('status-text');
      connDot.classList.add('online');
      statusText.textContent = 'âœ… Ù…ØªØµÙ„';
    }

    // Fetch Events
    async function getEvents() {
      try {
        const response = await fetch(API_URL);
        const data = await response.json();
        allEvents = data || [];

        updateStats();
        updateChart();
        updateMap(allEvents);
        renderTable();

        // Update device filter
        const devices = [...new Set(allEvents.map(e => e.device_id))];
        const select = document.getElementById('device-filter');
        const current = select.value;
        select.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</option>';
        devices.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          select.appendChild(opt);
        });
        select.value = current;
      } catch (err) {
        console.error('Error fetching events:', err);
        document.getElementById('conn-dot').classList.remove('online');
        document.getElementById('status-text').textContent = 'âŒ ØºÙŠØ± Ù…ØªØµÙ„';
      }
    }

    // Render Table
    function renderTable() {
      const levelFilter = document.getElementById('level-filter').value;
      const deviceFilter = document.getElementById('device-filter').value;

      let filtered = allEvents;
      if (levelFilter) filtered = filtered.filter(e => e.level === levelFilter);
      if (deviceFilter) filtered = filtered.filter(e => e.device_id === deviceFilter);

      const tbody = document.getElementById('events-table');
      tbody.innerHTML = '';
      filtered.slice().reverse().forEach(e => {
        const row = document.createElement('tr');
        row.className = `${e.level}-row`;
        row.innerHTML = `<td>${e.timestamp}</td><td>${e.device_id}</td><td>${e.type}</td><td>${e.level}</td><td>${e.status || 'open'}</td>`;
        tbody.appendChild(row);
      });
    }

    // Add Event
    async function addEvent(device, type, level) {
      const event = {
        device_id: device,
        type: type,
        level: level,
        timestamp: new Date().toISOString(),
        status: 'open',
        home_id: 'HOME-1234',
        absher_id: '1234567890'
      };
      try {
        await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(event)
        });
        getEvents();
      } catch (err) {
        console.error('Error adding event:', err);
      }
    }

    // Simulation
    async function startSimulation() {
      const devices = ['door_sensor_1', 'motion_sensor_1', 'camera_front', 'gas_sensor_kitchen', 'officer_1', 'officer_2'];
      const types = ['door_open', 'motion_detected', 'gas_detected', 'officer_safe'];
      const levels = ['info', 'warning', 'danger'];

      for (let i = 0; i < 15; i++) {
        const device = devices[Math.floor(Math.random() * devices.length)];
        const type = types[Math.floor(Math.random() * types.length)];
        const level = levels[Math.floor(Math.random() * levels.length)];
        await addEvent(device, type, level);
        await new Promise(r => setTimeout(r, 200));
      }
    }

    // Toggle Fetch
    function toggleFetch() {
      isFetching = !isFetching;
      if (isFetching) {
        fetchInterval = setInterval(getEvents, 3000);
        document.querySelector('button').textContent = 'â¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«';
      } else {
        clearInterval(fetchInterval);
        document.querySelector('button').textContent = 'â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«';
      }
    }

    // Reset Events
    async function resetEvents() {
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«ØŸ')) return;
      try {
        await fetch(API_URL + '/reset', { method: 'POST' });
        getEvents();
      } catch (err) {
        console.error('Error resetting events:', err);
      }
    }

    // Initialize
    window.addEventListener('load', () => {
      initMap();
      initChart();
      getEvents();
      fetchInterval = setInterval(getEvents, 3000);
    });
  </script>
</body>
</html>
