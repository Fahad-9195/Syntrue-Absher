<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ - Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ù†ØµØ© Ø£Ø¨Ø´Ø±</title>

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #020617;
      --card-bg: #020617;
      --card-gradient: radial-gradient(circle at top left, #0f172a, #020617);
      --card-border: #1e293b;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #38bdf8;
      --danger: #ef4444;
      --warning: #eab308;
      --info: #22c55e;
      --primary: #0ea5e9;
      --secondary: #06b6d4;
    }

    html, body {
      width: 100%;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: 
        radial-gradient(ellipse at top right, rgba(14, 165, 233, 0.15), transparent 50%),
        radial-gradient(ellipse at bottom left, rgba(16, 185, 129, 0.1), transparent 50%),
        linear-gradient(135deg, #020617 0%, #0f172a 50%, #000 100%);
      color: var(--text-main);
      direction: rtl;
      overflow-x: hidden;
      position: relative;
    }

    /* Animated background particles */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(14, 165, 233, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.03) 0%, transparent 50%);
      animation: drift 20s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes drift {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(20px, -20px); }
    }

    body {
      padding: 15px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      position: relative;
      z-index: 1;
    }

    .dashboard {
      width: 100%;
      max-width: 1400px;
      background: 
        linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.9)),
        linear-gradient(to bottom, transparent, rgba(14, 165, 233, 0.02));
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.5),
        0 0 100px rgba(14, 165, 233, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      padding: 20px;
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
    }

    .dashboard::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(14, 165, 233, 0.05) 0%, transparent 70%);
      animation: rotate 30s linear infinite;
      pointer-events: none;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .dashboard > * {
      position: relative;
      z-index: 1;
    }

    /* ===== HEADER ===== */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 15px;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--card-border);
    }

    .title-group h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .title-group p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    /* ===== CONNECTION STATUS ===== */
    .conn-status {
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.8);
    }

    .conn-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--info);
      box-shadow: 0 0 10px var(--info);
    }

    /* ===== BUTTONS ===== */
    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .btn {
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text-main);
      font-size: 12px;
      padding: 8px 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn:hover {
      border-color: var(--primary);
      background: rgba(14, 165, 233, 0.1);
      color: var(--primary-light);
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-color: var(--primary);
      color: white;
    }

    .btn.primary:hover {
      box-shadow: 0 0 20px rgba(14, 165, 233, 0.4);
    }

    .btn.danger {
      border-color: var(--danger);
      color: #fecaca;
    }

    .btn.danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    /* ===== STATS CARDS ===== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 15px;
    }

    .stat-card {
      background: 
        linear-gradient(135deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8));
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 
        0 10px 30px rgba(15, 23, 42, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, transparent, rgba(14, 165, 233, 0.1));
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .stat-card:hover {
      border-color: var(--primary);
      box-shadow: 
        0 15px 40px rgba(14, 165, 233, 0.2),
        0 0 30px rgba(14, 165, 233, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transform: translateY(-3px);
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .stat-description {
      font-size: 10px;
      color: var(--text-muted);
    }

    .stat-card.danger .stat-value {
      color: var(--danger);
    }

    .stat-card.warning .stat-value {
      color: var(--warning);
    }

    /* ===== MAIN GRID ===== */
    .layout-main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .card {
      background: var(--card-gradient);
      border: 1px solid var(--card-border);
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.5);
    }

    .card-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text-main);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title-hint {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 400;
    }

    #unified-map {
      width: 100%;
      height: 280px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.2);
    }

    #liveChart {
      width: 100%;
      height: 280px;
      position: relative;
    }

    .chart-container {
      position: relative;
      width: 100%;
      height: 280px;
    }

    /* ===== SECTIONS ===== */
    .officers-section {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }

    .officer-pill {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(0, 0, 0, 0.2);
    }

    .officer-pill span {
      font-weight: 700;
      font-size: 14px;
    }

    .officer-pill.safe {
      border-color: var(--info);
      color: #bbf7d0;
    }

    .officer-pill.warning {
      border-color: var(--warning);
      color: #fef3c7;
    }

    .officer-pill.danger {
      border-color: var(--danger);
      color: #fee2e2;
    }

    /* ===== TABLE ===== */
    .table-card {
      grid-column: 1 / -1;
    }

    .filters-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      align-items: flex-end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
    }

    .filter-group label {
      color: var(--text-muted);
      font-weight: 600;
    }

    .filter-group select {
      background: rgba(0, 0, 0, 0.3);
      color: var(--text-main);
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 11px;
      cursor: pointer;
      outline: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: linear-gradient(to right, rgba(14, 165, 233, 0.1), transparent);
    }

    th {
      padding: 10px;
      text-align: right;
      font-weight: 700;
      color: var(--primary);
      border-bottom: 1px solid var(--card-border);
    }

    td {
      padding: 10px;
      border-bottom: 1px solid rgba(30, 41, 59, 0.5);
      color: var(--text-main);
    }

    tbody tr:hover {
      background: rgba(14, 165, 233, 0.05);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge.danger {
      background: rgba(239, 68, 68, 0.2);
      color: #fecaca;
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

    .badge.warning {
      background: rgba(234, 179, 8, 0.2);
      color: #fef3c7;
      border: 1px solid rgba(234, 179, 8, 0.4);
    }

    .badge.info {
      background: rgba(34, 197, 94, 0.2);
      color: #bbf7d0;
      border: 1px solid rgba(34, 197, 94, 0.4);
    }

    /* ===== TOAST NOTIFICATIONS ===== */
    .toast-container {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }

    .toast {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 59, 0.95));
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease-out;
      position: relative;
      overflow: hidden;
    }

    .toast::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
    }

    .toast.success::before { background: var(--info); }
    .toast.error::before { background: var(--danger); }
    .toast.warning::before { background: var(--warning); }
    .toast.info::before { background: var(--primary); }

    .toast-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 4px;
      color: var(--text-main);
    }

    .toast-message {
      font-size: 12px;
      color: var(--text-muted);
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 20px;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .toast-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-main);
    }

    @keyframes slideIn {
      from {
        transform: translateX(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(-100%);
        opacity: 0;
      }
    }

    .toast.removing {
      animation: slideOut 0.3s ease-out forwards;
    }

    /* ===== LOADING SKELETONS ===== */
    .skeleton {
      background: linear-gradient(90deg, 
        rgba(30, 41, 59, 0.4) 25%, 
        rgba(51, 65, 85, 0.6) 50%, 
        rgba(30, 41, 59, 0.4) 75%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-text {
      height: 14px;
      margin: 8px 0;
    }

    .skeleton-card {
      height: 120px;
    }

    /* ===== PULSE ANIMATION FOR NEW ALERTS ===== */
    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }
      50% {
        box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
      }
    }

    .new-alert {
      animation: pulse 2s infinite;
    }

    /* ===== SMOOTH TRANSITIONS ===== */
    .card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.4),
        0 0 80px rgba(14, 165, 233, 0.15);
    }

    /* ===== THEME TOGGLE ===== */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.9));
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 24px;
      z-index: 1000;
      transition: all 0.3s;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .theme-toggle:hover {
      transform: scale(1.1) rotate(20deg);
      box-shadow: 0 6px 30px rgba(14, 165, 233, 0.4);
    }

    /* Light mode colors */
    body.light-mode {
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --card-border: #e2e8f0;
      --text-main: #1e293b;
      --text-muted: #64748b;
      background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 50%, #dbeafe 100%);
    }

    body.light-mode .dashboard {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(226, 232, 240, 0.8);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
    }

    body.light-mode .card {
      background: linear-gradient(135deg, #ffffff, #f8fafc);
      border: 1px solid #e2e8f0;
    }

    /* ===== SCROLLBAR ===== */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--card-border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 1024px) {
      .layout-main {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .dashboard {
        padding: 12px;
      }

      .dashboard-header {
        flex-direction: column;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 11px;
      }

      th, td {
        padding: 8px;
      }
    }
  </style>
</head>

<body>
  <div class="dashboard">
    <!-- HEADER -->
    <header class="dashboard-header">
      <div class="title-group">
        <h1>ğŸ”’ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ (Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ù†ØµØ© Ø£Ø¨Ø´Ø±)</h1>
        <p>Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© ÙˆØ§Ù„Ø¯ÙˆØ±ÙŠØ§Øª ÙˆØ§Ù„Ø¯Ø±ÙˆÙ† ÙˆØ§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø°ÙƒÙŠØ© ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ø­Ø¯Ø©</p>
      </div>
      <div class="header-right">
        <div id="connection-status" class="conn-status">
          <span class="conn-dot"></span>
          <span>Ù…ØªØµÙ„</span>
        </div>
      </div>
    </header>

    <!-- CONTROLS -->
    <div class="controls-row">
      <button class="btn" onclick="window.location.href='/static/operations-center.html'" style="background: linear-gradient(135deg, #10b981, #059669); border-color: #10b981; color: white;">ğŸš” Ù…Ø±ÙƒØ² Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
      <button class="btn" onclick="window.location.href='/static/officer-device.html'" style="background: linear-gradient(135deg, #f59e0b, #d97706); border-color: #f59e0b; color: white;">ğŸ‘® Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ</button>
      <button class="btn" onclick="window.location.href='/static/analytics.html'" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-color: #8b5cf6; color: white;">ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</button>
      <button class="btn primary" onclick="toggleFetch()" id="toggle-btn">â¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«</button>
      <button class="btn" onclick="startSimulation()" id="sim-btn">â–¶ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</button>
      <button class="btn" onclick="exportCSV()">ğŸ“¥ ØªØµØ¯ÙŠØ± CSV</button>
      <button class="btn" onclick="importCSV()">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV</button>
      <button class="btn" onclick="resolveAll()">âœ… Ø­Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</button>
      <button class="btn" onclick="resetEvents()">ğŸ—‘ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</button>
      <button class="btn danger" onclick="openReports()">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    </div>

    <!-- STATS -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</div>
        <div class="stat-value" id="total-count">0</div>
        <div class="stat-description">Ø­Ø¯Ø« Ù…Ø³Ø¬Ù„</div>
      </div>

      <div class="stat-card warning">
        <div class="stat-label">âš ï¸ Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ­Ø°ÙŠØ±</div>
        <div class="stat-value" id="warning-count">0</div>
        <div class="stat-description">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª ØªØ­Ø°ÙŠØ±ÙŠØ©</div>
      </div>

      <div class="stat-card danger">
        <div class="stat-label">ğŸš¨ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø·Ø±</div>
        <div class="stat-value" id="danger-count">0</div>
        <div class="stat-description">ØªØ­ØªØ§Ø¬ ØªØ¯Ø®Ù„ ÙÙˆØ±ÙŠ</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">â° Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</div>
        <div class="stat-value" id="last-update" style="font-size: 16px;">Ø§Ù„Ø¢Ù†</div>
        <div class="stat-description">ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø±</div>
      </div>
    </div>

    <!-- MAIN LAYOUT -->
    <div class="layout-main">
      <!-- CHART -->
      <div class="card">
        <div class="card-title">
          <span>ğŸ“ˆ Ù…Ø®Ø·Ø· Ø­ÙŠ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</span>
          <span class="card-title-hint">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ ÙƒÙ„ 3 Ø«ÙˆØ§Ù†Ù</span>
        </div>
        <div class="chart-container">
          <canvas id="liveChart"></canvas>
        </div>
      </div>

      <!-- MAP -->
      <div class="card">
        <div class="card-title">
          <span>ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ø£Ù…Ù† Ø§Ù„Ø°ÙƒÙŠ</span>
          <span class="card-title-hint">Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ù†Ø²Ù„ + Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª</span>
        </div>
        <div id="unified-map"></div>
      </div>
    </div>

    <!-- OFFICERS SECTION -->
    <div class="card">
      <div class="card-title">
        ğŸ‘® ÙˆØ¶Ø¹ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ø§Ù„Ø³Ø±Ù‘ÙŠØ©
        <span id="officer-summary" class="card-title-hint">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...</span>
      </div>
      <div class="officers-section">
        <div class="officer-pill safe">
          âœ… Ø¢Ù…Ù†
          <span id="officer-safe">0</span>
        </div>
        <div class="officer-pill warning">
          âš ï¸ ØºÙŠØ± Ù…Ø³ØªÙ‚Ø±
          <span id="officer-unstable">0</span>
        </div>
        <div class="officer-pill danger">
          ğŸš¨ Ø·Ø§Ø±Ø¦
          <span id="officer-emergency">0</span>
        </div>
      </div>
    </div>

    <!-- DEVICES SUMMARY -->
    <div class="card">
      <div class="card-title">
        ğŸ”§ Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
        <span class="card-title-hint">Ø£ÙƒØ«Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¥Ø±Ø³Ø§Ù„Ø§Ù‹ Ù„Ù„Ø¨Ù„Ø§ØºØ§Øª</span>
      </div>
      <ul id="devices-summary" style="list-style: none; padding: 0; margin: 0; font-size: 12px; color: var(--text-muted);">
        <li>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</li>
      </ul>
    </div>

    <!-- EVENTS TABLE -->
    <div class="card table-card">
      <div class="card-title">
        ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        <span class="card-title-hint">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØ§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø¬Ù‡Ø§Ø²</span>
      </div>

      <div class="filters-row">
        <div class="filter-group">
          <label>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©</label>
          <select id="level-filter" onchange="filterTable()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="danger">ğŸ”´ Ø®Ø·Ø±</option>
            <option value="warning">ğŸŸ¡ ØªØ­Ø°ÙŠØ±</option>
            <option value="info">ğŸŸ¢ Ù…Ø¹Ù„ÙˆÙ…Ø©</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Ø§Ù„Ø¬Ù‡Ø§Ø²</label>
          <select id="device-filter" onchange="filterTable()">
            <option value="">ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="status-filter" onchange="filterTable()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="open">Ù…ÙØªÙˆØ­</option>
            <option value="resolved">ØªÙ… Ø§Ù„Ø­Ù„</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Ø§Ù„Ù…Ø¯Ø©</label>
          <select id="time-filter" onchange="filterTable()">
            <option value="">ÙƒÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª</option>
            <option value="5">Ø¢Ø®Ø± 5 Ø¯Ù‚Ø§Ø¦Ù‚</option>
            <option value="15">Ø¢Ø®Ø± 15 Ø¯Ù‚ÙŠÙ‚Ø©</option>
            <option value="60">Ø¢Ø®Ø± Ø³Ø§Ø¹Ø©</option>
          </select>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>â° Ø§Ù„ÙˆÙ‚Øª</th>
            <th>ğŸ“ Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
            <th>ğŸ”” Ø§Ù„Ù†ÙˆØ¹</th>
            <th>âš ï¸ Ø§Ù„Ø®Ø·ÙˆØ±Ø©</th>
            <th>âœ“ Ø§Ù„Ø­Ø§Ù„Ø©</th>
          </tr>
        </thead>
        <tbody id="events-table">
          <tr>
            <td colspan="5" style="text-align: center; color: var(--text-muted);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <input type="file" id="file-input" accept=".csv" style="display: none;" />

  <script>
    const API_URL = "https://syntrue-absher.onrender.com/api/events";
    let allEvents = [];
    let fetchInterval = null;
    let chartInstance = null;
    let map = null;
    let isFetching = true;
    let simulationRunning = false;

    // Audio System
    let audioContext = null;
    let lastDangerAlertTime = 0;
    const ALERT_COOLDOWN = 5000;

    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }

    function playBeep(frequency, duration, type = 'sine') {
      initAudio();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = frequency;
      oscillator.type = type;
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + duration);
    }

    function playDangerAlert() {
      const now = Date.now();
      if (now - lastDangerAlertTime < ALERT_COOLDOWN) return;
      lastDangerAlertTime = now;

      playBeep(800, 0.2, 'square');
      setTimeout(() => playBeep(600, 0.2, 'square'), 200);
      setTimeout(() => playBeep(800, 0.2, 'square'), 400);
      setTimeout(() => playBeep(600, 0.2, 'square'), 600);
    }

    const deviceCoords = {
      door_sensor_1: [24.7136, 46.6753],
      motion_sensor_1: [24.7143, 46.6768],
      camera_front: [24.7129, 46.6742],
      gas_sensor_kitchen: [24.7130, 46.6760],
    };

    function initMap() {
      if (map) return;
      const center = [24.7136, 46.6753];
      map = L.map("unified-map").setView(center, 14);
      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

      // Add device markers
      Object.entries(deviceCoords).forEach(([id, coords]) => {
        L.circleMarker(coords, { radius: 6, color: "#0ea5e9", fillColor: "#0ea5e9", fillOpacity: 0.8 })
          .bindPopup(`<b>${id}</b>`)
          .addTo(map);
      });

      // Add home boundary
      L.rectangle([[24.7126, 46.6745], [24.7146, 46.6765]], {
        color: "#38bdf8",
        weight: 2,
        dashArray: "5 5",
        fillOpacity: 0.02,
      }).addTo(map);
    }

    function initChart() {
      const ctx = document.getElementById("liveChart").getContext("2d");
      chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«",
              data: [],
              borderColor: "#0ea5e9",
              backgroundColor: "rgba(14, 165, 233, 0.1)",
              borderWidth: 2,
              tension: 0.3,
              fill: true,
              pointRadius: 3,
              pointBackgroundColor: "#0ea5e9",
              pointBorderColor: "#fff",
              pointBorderWidth: 1,
              pointHoverRadius: 5,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          animation: {
            duration: 0,
          },
          interaction: {
            intersect: false,
            mode: "index",
          },
          plugins: {
            legend: {
              labels: {
                color: "#e5e7eb",
                padding: 15,
              },
            },
            filler: {
              propagate: true,
            },
          },
          scales: {
            x: {
              ticks: {
                color: "#9ca3af",
                font: { size: 11 },
              },
              grid: {
                color: "rgba(148, 163, 184, 0.1)",
                drawBorder: false,
              },
            },
            y: {
              ticks: {
                color: "#9ca3af",
                font: { size: 11 },
                beginAtZero: true,
              },
              grid: {
                color: "rgba(148, 163, 184, 0.1)",
                drawBorder: false,
              },
              beginAtZero: true,
              max: undefined,
            },
          },
        },
      });
    }

    function updateChart() {
      if (!chartInstance) return;
      const now = new Date();
      const label = now.toLocaleTimeString("ar-SA", { hour: "2-digit", minute: "2-digit" });
      
      // Count only unresolved events for chart
      const unresolvedCount = allEvents.filter(e => !e.status || e.status === "open").length;
      
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©ØŒ Ù†Ø­Ø¯Ø« Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø©
      const lastLabel = chartInstance.data.labels[chartInstance.data.labels.length - 1];
      if (lastLabel === label && chartInstance.data.labels.length > 0) {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø©
        chartInstance.data.datasets[0].data[chartInstance.data.datasets[0].data.length - 1] = unresolvedCount;
      } else {
        // Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø©
        chartInstance.data.labels.push(label);
        chartInstance.data.datasets[0].data.push(unresolvedCount);
        
        // Ø­ÙØ¸ Ø¢Ø®Ø± 30 Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
        if (chartInstance.data.labels.length > 30) {
          chartInstance.data.labels.shift();
          chartInstance.data.datasets[0].data.shift();
        }
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø³Ù„Ø³ Ø¨Ø¯ÙˆÙ† Ø±Ø³Ù… Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
      chartInstance.update("none");
    }

    async function getEvents() {
      try {
        const response = await fetch(API_URL);
        allEvents = (await response.json()) || [];

        // Count only unresolved events for statistics
        const unresolvedEvents = allEvents.filter(e => !e.status || e.status === "open");
        
        document.getElementById("total-count").textContent = unresolvedEvents.length;
        document.getElementById("danger-count").textContent = unresolvedEvents.filter(e => e.level === "danger").length;
        document.getElementById("warning-count").textContent = unresolvedEvents.filter(e => e.level === "warning").length;
        document.getElementById("last-update").textContent = new Date().toLocaleTimeString("ar-SA", { hour: "2-digit", minute: "2-digit", second: "2-digit" });

        // Update device filter
        const devices = [...new Set(allEvents.map(e => e.device_id))];
        const select = document.getElementById("device-filter");
        select.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</option>';
        devices.forEach(d => {
          const opt = document.createElement("option");
          opt.value = d;
          opt.textContent = d;
          select.appendChild(opt);
        });

        // Update officers - count only unresolved
        const officers = allEvents.filter(e => e.device_id?.startsWith("officer_") && (!e.status || e.status === "open"));
        let safe = 0, unstable = 0, emergency = 0;
        officers.forEach(e => {
          if (e.level === "info") safe++;
          else if (e.level === "warning") unstable++;
          else if (e.level === "danger") emergency++;
        });
        document.getElementById("officer-safe").textContent = safe;
        document.getElementById("officer-unstable").textContent = unstable;
        document.getElementById("officer-emergency").textContent = emergency;

        // Play alert sound ONLY if there's unresolved danger
        const unresolvedDanger = allEvents.filter(e => 
          e.level === "danger" && (!e.status || e.status === "open")
        ).length;
        
        if (unresolvedDanger > 0) {
          playDangerAlert();
        }

        // Update devices summary
        const counts = {};
        allEvents.forEach(e => counts[e.device_id] = (counts[e.device_id] || 0) + 1);
        const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 5);
        const list = document.getElementById("devices-summary");
        list.innerHTML = sorted.length > 0
          ? sorted.map(([d, c]) => `<li>â€¢ ${d}: <strong>${c}</strong> Ø£Ø­Ø¯Ø§Ø«</li>`).join("")
          : "<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</li>";

        updateChart();
        filterTable();
      } catch (err) {
        console.error("API Error:", err);
      }
    }

    function filterTable() {
      const levelFilter = document.getElementById("level-filter").value;
      const deviceFilter = document.getElementById("device-filter").value;
      const statusFilter = document.getElementById("status-filter").value;
      const timeFilter = document.getElementById("time-filter").value;

      let filtered = allEvents;

      if (levelFilter) filtered = filtered.filter(e => e.level === levelFilter);
      if (deviceFilter) filtered = filtered.filter(e => e.device_id === deviceFilter);
      if (statusFilter) filtered = filtered.filter(e => (e.status || "open") === statusFilter);

      if (timeFilter) {
        const mins = parseInt(timeFilter);
        const now = Date.now();
        const threshold = now - mins * 60 * 1000;
        filtered = filtered.filter(e => new Date(e.timestamp).getTime() >= threshold);
      }

      renderTable(filtered);
    }

    function renderTable(events) {
      const tbody = document.getElementById("events-table");
      tbody.innerHTML = events.length === 0
        ? '<tr><td colspan="5" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø«</td></tr>'
        : events.slice().reverse().map(e => {
          const badgeClass = e.level === "danger" ? "danger" : e.level === "warning" ? "warning" : "info";
          return `<tr>
            <td>${new Date(e.timestamp).toLocaleString("ar-SA", { hour: "2-digit", minute: "2-digit", second: "2-digit" })}</td>
            <td>${e.device_id}</td>
            <td>${e.type}</td>
            <td><span class="badge ${badgeClass}">${e.level}</span></td>
            <td>${e.status || "open"}</td>
          </tr>`;
        }).join("");
    }

    async function addEvent(device, type, level) {
      try {
        await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ device_id: device, type, level, timestamp: new Date().toISOString(), status: "open", home_id: "HOME-1234", absher_id: "1234567890" }),
        });
        getEvents();
      } catch (err) { console.error(err); }
    }

    async function startSimulation() {
      const devices = ["door_sensor_1", "motion_sensor_1", "camera_front", "gas_sensor_kitchen", "officer_1", "officer_2", "officer_3"];
      const types = ["door_open", "motion_detected", "gas_detected", "officer_safe", "officer_unstable", "officer_emergency"];
      const levels = ["info", "warning", "danger"];

      simulationRunning = true;
      document.getElementById("sim-btn").textContent = "â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©";

      while (simulationRunning) {
        for (let i = 0; i < 8; i++) {
          const device = devices[Math.floor(Math.random() * devices.length)];
          const type = types[Math.floor(Math.random() * types.length)];
          const level = levels[Math.floor(Math.random() * levels.length)];
          await addEvent(device, type, level);
          await new Promise(r => setTimeout(r, 300));
        }
        await new Promise(r => setTimeout(r, 2000));
      }
    }

    function stopSimulation() {
      simulationRunning = false;
      document.getElementById("sim-btn").textContent = "â–¶ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©";
    }

    async function resetEvents() {
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«ØŸ")) return;
      try {
        await fetch(API_URL + "/reset", { method: "POST" });
        getEvents();
      } catch (err) { console.error(err); }
    }

    async function resolveAll() {
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¹Ù„ÙŠÙ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª ÙƒÙ€ ØªÙ… Ø§Ù„Ø­Ù„ØŸ")) return;
      try {
        await fetch(API_URL + "/resolve_all", { method: "POST" });
        await getEvents(); // Refresh data
        updateChart(); // Update chart immediately
      } catch (err) { console.error(err); }
    }

    function toggleFetch() {
      isFetching = !isFetching;
      document.getElementById("toggle-btn").textContent = isFetching ? "â¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«" : "â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«";
    }

    function exportCSV() {
      if (allEvents.length === 0) { alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª"); return; }
      const csv = "Ø§Ù„ÙˆÙ‚Øª;Ø§Ù„Ø¬Ù‡Ø§Ø²;Ø§Ù„Ù†ÙˆØ¹;Ø§Ù„Ø®Ø·ÙˆØ±Ø©;Ø§Ù„Ø­Ø§Ù„Ø©\n" +
        allEvents.map(e => `${e.timestamp};${e.device_id};${e.type};${e.level};${e.status || "open"}`).join("\n");
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "events.csv";
      link.click();
    }

    function importCSV() {
      document.getElementById("file-input").click();
    }

    document.getElementById("file-input").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      const lines = text.split("\n").slice(1);
      for (const line of lines) {
        if (!line.trim()) continue;
        const [timestamp, device_id, type, level, status] = line.split(";");
        await addEvent(device_id, type, level);
      }
    });

    function openReports() {
      const win = window.open("", "_blank");
      const html = `<html dir="rtl"><head><meta charset="UTF-8"><title>ØªÙ‚Ø±ÙŠØ±</title></head><body style="font-family:Arial;padding:20px"><h1>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ</h1><p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«: ${allEvents.length}</p><button onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button><table border="1" cellpadding="5" style="width:100%;margin-top:20px"><thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø®Ø·ÙˆØ±Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>${allEvents.slice().reverse().map(e => `<tr><td>${e.timestamp}</td><td>${e.device_id}</td><td>${e.type}</td><td>${e.level}</td><td>${e.status || "open"}</td></tr>`).join("")}</tbody></table></body></html>`;
      win.document.write(html);
      win.document.close();
    }

    document.getElementById("sim-btn").addEventListener("click", () => {
      if (simulationRunning) stopSimulation();
      else startSimulation();
    });

    window.addEventListener("load", () => {
      initMap();
      initChart();
      getEvents();
      fetchInterval = setInterval(() => { if (isFetching) getEvents(); }, 3000);
    });
  </script>
</body>
</html>
